# Android 单元测试之-Robolectric


## 简介

---

Robolectric is a unit test framework that de-fangs the Android SDK jar so you can test-drive the development of your Android app. Tests run inside the JVM on your workstation in seconds. With Robolectric you can write tests like this:

```
@RunWith(RobolectricTestRunner.class)
public class MyActivityTest {

  @Test
  public void clickingButton_shouldChangeResultsViewText() throws Exception {
    MyActivity activity = Robolectric.setupActivity(MyActivity.class);

    Button button = (Button) activity.findViewById(R.id.button);
    TextView results = (TextView) activity.findViewById(R.id.results);

    button.performClick();
    assertThat(results.getText().toString()).isEqualTo("Robolectric Rocks!");
  }
}
```
Robolectric makes this possible by rewriting Android SDK classes as they're being loaded and making it possible for them to run on a regular JVM.

Robolectric在其所提供的测试框架中，完全模拟了Android SDK的jar文件（不会再有恼人的stub异常），它使得我们的测试可以运行于JVM之上（速度得到大幅度的提升），因此我们可以用它对Android应用进行测试驱动开发。Roblectric同时实现了Android中对XML的解析，模拟了View，Layout，以及资源的加载，它使得Android的环境对于开发人员来说更像是一个黑盒，从而使开发人员不用大量使用mock，就可以方便的对资源状态和Android相关的代码进行测试。 也就说它通过实现一套JVM能运行的Android代码，然后在unit test运行的时候去截取android相关的代码调用，然后转到他们的他们实现的代码去执行这个调用的过程。


Robolectric是如何做到这点的呢？

Robolectric使用了javassist在运行时动态修改Android.jar中类的byte code，Robolectric会在JVM加载Android.jar包的时候，重写其中类的方法。Roblectroic会让这些方法有返回值（null或是0） 而不是抛出异常 ，或者将这些方法调用转向Shadow Objects来模拟Android SDK的实现。Shadow Objects是Robolectric在运行时插入到Android.jar包相应的类中的，它们会实际处理方法的调用，并记录相应的状态，以备在assert的时候进行查询




## 配置

---

### Gradlew
build.gradle下添加:

```
testCompile "org.robolectric:robolectric:3.1.4"
```

如果使用support的Fragment，需添加以下依赖:

```
testCompile "org.robolectric:shadows-support-v4:3.1.4"
```

相应的测试类添加:

```
@RunWith(RobolectricTestRunner.class)
@Config(constants = BuildConfig.class)
public class SandwichTest {
}
```

>Note that you must specify the constants field which points to the BuildConfig.class generated by the build system. Robolectric uses the constants in the class to compute the output paths used by Gradle when building your project. Without these values, Robolectric will not be able to find your merged manifest, resources, or assets.


### Maven

pom.xml添加:

```
<dependency>
   <groupId>org.robolectric</groupId>
   <artifactId>robolectric</artifactId>
   <version>3.1.4</version>
   <scope>test</scope>
</dependency>
```

测试类指定@RunWith(RobolectricTestRunner.class):

```
@RunWith(RobolectricTestRunner.class)
public class SandwichTest {
}
```



在linux或者mac上, 可能还需要对"default JUnit test runner configuration"进行配置"in order to work around a bug where Android Studio does not set the working directory to the module being tested."

操作步骤: Run->Edit configurations->Defaults->JUnit, working directory 设置为"$MODULE_DIR$", 操作界面见下图:

![配置图](http://robolectric.org/images/android-studio-configure-defaults-4bf48402.png)

最新版本的gradle发现默认已经配置了.


## 需要了解...

---

1. ActivityController
1. ShadowApplication



## Activity的测试

---

todo...

## BroadcastReceiver的测试

---

todo...

## Service的测试

---

todo...


## Shodaw的使用

---

todo...



## Reference 

---

1. [Robolectric](http://robolectric.org/)
1. [robolectric-parent 3.1 API](http://robolectric.org/javadoc/3.1/index.html)
1. [robolectric 常用Api解释](https://hkliya.gitbooks.io/unit-test-android-with-robolectric/content/2-api-explained.html)
1. [Android单元测试框架Robolectric3.0介绍(一)](http://www.jianshu.com/p/9d988a2f8ff7)
1. [Android单元测试框架Robolectric3.0介绍(二)](http://www.jianshu.com/p/3aa0e4efcfd3)
1. [2.4-to-3.0-Upgrade-Guide](https://github.com/robolectric/robolectric/wiki/2.4-to-3.0-Upgrade-Guide)
1. [Unit Testing with Robolectric](https://guides.codepath.com/android/Unit-Testing-with-Robolectric)
1. [Android单元测试利器–Robolectric 结合powermock测试](http://www.tuicool.com/articles/z67FZba)






	public static void getToken(Async<String> task, TaskBack<String> listener) {



public static abstract class TaskBack<T> implements ITaskBack<T> {
        @Override
        public void onResult(AsyncResult<ExecResult<T>> result) {



http://stackoverflow.com/questions/38014167/detect-if-private-static-final-fields-method-is-called-with-mockito